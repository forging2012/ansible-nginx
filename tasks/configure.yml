# configure.yml

- name: Nginx | Updating mime.types file
  copy:
    src: mime.types
    dest: "{{nginx_dir}}/mime.types"
    owner: root
    group: root
    mode: 0644

- name: Nginx | Checking for an existing nginx.conf file
  stat:
    path: "{{nginx_dir}}/nginx.conf"
  register: nginx_config

- name: Nginx | Updating the nginx.conf file
  template:
    src: nginx.conf.j2
    dest: "{{nginx_dir}}/nginx.conf"
    owner: root
    group: root
    mode: 0644
    when: ngx_plus_lb_template == "no"
  notify:
    - restart nginx

- name: Nginx Plus | Updating the nginx.conf file from template
  template:
    src: nginx_plus_nginx.conf.j2
    dest: "{{nginx_dir}}/nginx.conf"
    owner: root
    group: root
    mode: 0644
    when: ngx_plus_lb_template == "yes"
  notify:
    - restart nginx

- name: Nginx Plus | Updating the conf.d/default.conf file from template
  template:
    src: nginx_plus_default.conf.j2
    dest: "{{nginx_dir}}/conf.d/default.conf"
    owner: root
    group: root
    mode: 0644
    when: ngx_plus_lb_template == "yes"
  notify:
    - restart nginx:

# rabbit mq install used to demo tcp upstream withing Nginx Plus

- include: rabbitmq.yml
  when: rabbitmq_install == "yes"

- name: Nginx | Starting Nginx for the first time
  service:
    name: nginx
    state: started
  register: nginx_first_start
  when: not nginx_config.stat.exists
